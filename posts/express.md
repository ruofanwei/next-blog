---
title: 'Implement Validator and Logger in Express.js'
date: '2020-06-11'
---

## Middleware - Express Validator

å»ºç«‹é©—è­‰requestçš„middlewareå¯ä»¥çµ±ä¸€é©—è­‰çš„æ©Ÿåˆ¶åœ¨ä¸€å€‹æª”æ¡ˆå…§ï¼Œä¸æœƒæ•£è½åœ¨controlleræª”æ¡ˆä¸­å„è™•

`check()`å¾ request ä¸­çš„å…­å€‹ç‰©ä»¶è£¡é©—è­‰ï¼š req.bodyã€req.cookiesã€req.headersã€req.paramã€req.query


`body()` åªæœƒå¾req.bodyé©—è­‰

`bail()` å¦‚æœå‰é¢çš„é©—è­‰æ²’æœ‰é€šéå°±ä¸æœƒè·‘å¾Œé¢çš„é©—è­‰

```javascript
// Middleware.JS
const {
  body,
  param,
  check,
  validationResult,
} = require("express-validator")


const paymentAndReceiptValidationRules = () => {
  return [
    param("planId").exists().toInt().withMessage("planId is invalid"),
    param("receiptType")
      .isIn([
        "personalReceipt",
        "companyReceipt",
        "cloudReceipt",
        "donateReceipt",
      ])
      .not()
      .isEmpty()
      .withMessage("receiptType is invalid"),
    body("uniformNumber")
      // if the param is companyReceipt
      .if(param("receiptType").isIn(["companyReceipt"]))
      .bail()
      // If receiptType is not companyReceipt, below will never run
      .not()
      .isEmpty()
      .matches(/^[0-9]{8}$/)
      .withMessage("uniformNumber field error"),
    body("carrierType")
      // if the param is cloudReceipt
      .if(param("receiptType").isIn(["cloudReceipt"]))
      .bail()
      // If receiptType is not cloudReceipt, below will never run
      // è¼‰å…·é¡å‹(Optional) 3J0002=>æ‰‹æ©Ÿæ¢ç¢¼,CQ0001=>è‡ªç„¶äººæ†‘è­‰
      .isIn(["CQ0001", "3J0002"])
      .not()
      .isEmpty()
      .withMessage("carrierType field error"),
    body("carrierId")
      // if the param is cloudReceipt
      .if(param("receiptType").isIn(["cloudReceipt"]))
      // è¼‰å…·é¡å‹(Optional) CQ0001=>è‡ªç„¶äººæ†‘è­‰
      .if(body("carrierType").isIn(["CQ0001"]))
      .bail()
      // If receiptType is not cloudReceipt  and carrierType is not CQ0001, below will never run
      .not()
      .isEmpty()
      .matches(/^[A-Z]{2}[0-9]{14}$/)
      .withMessage("carrierId field error"),
    body("carrierId")
      // if the param is cloudReceipt
      .if(param("receiptType").isIn(["cloudReceipt"]))
      // è¼‰å…·é¡å‹(Optional) 3J0002=>æ‰‹æ©Ÿæ¢ç¢¼
      .if(body("carrierType").isIn(["3J0002"]))
      .bail()
      // If receiptType is not cloudReceipt and carrierType is not 3J0002, below will never run
      .not()
      .isEmpty()
      .matches(/^\/{1}[0-9A-Z]{7}$/)
      .withMessage("carrierId field error"),
    body("donateNumber")
      // if the param is donateReceipt
      .if(param("receiptType").isIn(["donateReceipt"]))
      .bail()
      // If receiptType is not donateReceipt, below will never run
      .not()
      .isEmpty()
      .withMessage("donateNumber field error"),
    body("callbackUrl").not().isEmpty().withMessage("callbackUrl field error"),
  ]
}

const validate = (req, res, next) => {
  const errors = validationResult(req)
  // hasErrors is true
  if (!errors.isEmpty()) {
    const extractedErrors = []
    errors
      .array()
      .map((error) => extractedErrors.push({[error.param]: error.msg}))
    return res.status(400).json({
      code: 400,
      errors: extractedErrors,
      message: "è³‡æ–™æ ¼å¼éŒ¯èª¤",
    })
  } else {
    next()
  }
}

module.exports = {

  /* for notify */
  paymentAndReceiptValidationRules,
  validate,
}
```

## Use winston logger in google cloud platform

#### Setting
```
npm i winston
```

- ğŸ“‚ Logs - will save the log files generated by the Winston file transport.
- ğŸ“‚ Utils - will hold WinstonÂ logger.jsğŸ—„ï¸ where we will add configurations such as Winston transport and formatting.

å»ºç«‹logging åœ¨æª”æ¡ˆé‚„æœ‰é›²ç«¯è¿½è¹¤ç´€éŒ„ï¼Œåœ¨localæ‰“apiä¹Ÿå¯ä»¥é¡¯ç¤ºç´€éŒ„åœ¨é›²ç«¯
- check out :point_right: [Authenticating as a service account ](https://cloud.google.com/docs/authentication/production)

```javascript
// utils/logger.js
const { Storage } = require("@google-cloud/storage")
const winston = require("winston")
const { createLogger, transports } = require("winston")
const { format } = require("logform")
const { errors } = format

// Imports the Google Cloud client library for Winston
const {LoggingWinston} = require("@google-cloud/logging-winston")
require("dotenv").config()

// Creates a client
const loggingWinston = new LoggingWinston({
  projectId: process.env.PROJECTId,
  keyFilename: process.env.GOOGLE_APPLICATION_CREDENTIALS,
  level: "info", // log at 'warn' and above ,
})

const timezoned = () => {
  return new Date().toLocaleString("zh-TW", {
    timeZone: "Asia/Taipei",
  })
}

// In order for Google Cloud Logging API to understand the log level correctly
const GoogleCloudLoggingFormatter = winston.format((info, opts = {}) => {
  info["severity"] = info["level"].toUpperCase()
  return info
})

// Create a Winston logger that streams to Stackdriver Logging
// Logs will be written to: "projects/YOUR_PROJECT_ID/logs/winston_log"
const logConfiguration = {
  level: "info",
  format: winston.format.combine(
    winston.format.label({
      label: "ğŸ”¥",
    }),
    winston.format.timestamp({
      format: timezoned,
    }),
    GoogleCloudLoggingFormatter(), // This must be before winston.format.printf()
    winston.format.printf(
      (info) =>
        `${info.level}:${info.label} ${[info.timestamp]} ${info.message}`
    )
  ),
  transports: [
    new transports.File({
      filename: "logs/winston.log",
      format: format.combine(format.align()),
    }),
    new transports.Console({
      format: format.combine(
        format.align(),
        format.colorize({
          all: true,
        }),
        format.label({
          label: "ğŸ”¥",
        })
      ),
    }),
    // Add Stackdriver Logging
    loggingWinston,
  ],
}
module.exports = logger

```
```javascript
// logs/ winston.log

info:ğŸ”¥ 2021/6/8 ä¸‹åˆ4:20:32 PUT - /setting/smsPlanFromMsoa
info:ğŸ”¥ 2021/6/8 ä¸‹åˆ4:20:32 msoaCentralId: 43
info:ğŸ”¥ 2021/6/8 ä¸‹åˆ4:20:33 response from msoa - message: Success, statue code: 200
info:ğŸ”¥ 2021/6/8 ä¸‹åˆ4:20:33 SmsPlansFromMsoa is update into database
info:ğŸ”¥ 2021/6/8 ä¸‹åˆ4:20:33  update msoa data into database - msoaDmpv successfully
```


### Reference :full_moon_with_face:
- [for express-validator](https://express-validator.github.io/docs/)
- [for logger](https://github.com/winstonjs/winston)
