---
title: 'Implement Validator and Logger in Express.js'
date: '2020-06-11'
---

## Middleware - Express Validator

建立驗證request的middleware可以統一驗證的機制在一個檔案內，不會散落在controller檔案中各處

`check()`從 request 中的六個物件裡驗證： req.body、req.cookies、req.headers、req.param、req.query


`body()` 只會從req.body驗證

`bail()` 如果前面的驗證沒有通過就不會跑後面的驗證

```javascript
// Middleware.JS
const {
  body,
  param,
  check,
  validationResult,
} = require("express-validator")


const paymentAndReceiptValidationRules = () => {
  return [
    param("planId").exists().toInt().withMessage("planId is invalid"),
    param("receiptType")
      .isIn([
        "personalReceipt",
        "companyReceipt",
        "cloudReceipt",
        "donateReceipt",
      ])
      .not()
      .isEmpty()
      .withMessage("receiptType is invalid"),
    body("uniformNumber")
      // if the param is companyReceipt
      .if(param("receiptType").isIn(["companyReceipt"]))
      .bail()
      // If receiptType is not companyReceipt, below will never run
      .not()
      .isEmpty()
      .matches(/^[0-9]{8}$/)
      .withMessage("uniformNumber field error"),
    body("carrierType")
      // if the param is cloudReceipt
      .if(param("receiptType").isIn(["cloudReceipt"]))
      .bail()
      // If receiptType is not cloudReceipt, below will never run
      // 載具類型(Optional) 3J0002=>手機條碼,CQ0001=>自然人憑證
      .isIn(["CQ0001", "3J0002"])
      .not()
      .isEmpty()
      .withMessage("carrierType field error"),
    body("carrierId")
      // if the param is cloudReceipt
      .if(param("receiptType").isIn(["cloudReceipt"]))
      // 載具類型(Optional) CQ0001=>自然人憑證
      .if(body("carrierType").isIn(["CQ0001"]))
      .bail()
      // If receiptType is not cloudReceipt  and carrierType is not CQ0001, below will never run
      .not()
      .isEmpty()
      .matches(/^[A-Z]{2}[0-9]{14}$/)
      .withMessage("carrierId field error"),
    body("carrierId")
      // if the param is cloudReceipt
      .if(param("receiptType").isIn(["cloudReceipt"]))
      // 載具類型(Optional) 3J0002=>手機條碼
      .if(body("carrierType").isIn(["3J0002"]))
      .bail()
      // If receiptType is not cloudReceipt and carrierType is not 3J0002, below will never run
      .not()
      .isEmpty()
      .matches(/^\/{1}[0-9A-Z]{7}$/)
      .withMessage("carrierId field error"),
    body("donateNumber")
      // if the param is donateReceipt
      .if(param("receiptType").isIn(["donateReceipt"]))
      .bail()
      // If receiptType is not donateReceipt, below will never run
      .not()
      .isEmpty()
      .withMessage("donateNumber field error"),
    body("callbackUrl").not().isEmpty().withMessage("callbackUrl field error"),
  ]
}

const validate = (req, res, next) => {
  const errors = validationResult(req)
  // hasErrors is true
  if (!errors.isEmpty()) {
    const extractedErrors = []
    errors
      .array()
      .map((error) => extractedErrors.push({[error.param]: error.msg}))
    return res.status(400).json({
      code: 400,
      errors: extractedErrors,
      message: "資料格式錯誤",
    })
  } else {
    next()
  }
}

module.exports = {

  /* for notify */
  paymentAndReceiptValidationRules,
  validate,
}
```

## Use winston logger in google cloud platform

#### Setting
```
npm i winston
```

- 📂 Logs - will save the log files generated by the Winston file transport.
- 📂 Utils - will hold Winston logger.js🗄️ where we will add configurations such as Winston transport and formatting.

建立logging 在檔案還有雲端追蹤紀錄，在local打api也可以顯示紀錄在雲端
- check out :point_right: [Authenticating as a service account ](https://cloud.google.com/docs/authentication/production)

```javascript
// utils/logger.js
const { Storage } = require("@google-cloud/storage")
const winston = require("winston")
const { createLogger, transports } = require("winston")
const { format } = require("logform")
const { errors } = format

// Imports the Google Cloud client library for Winston
const {LoggingWinston} = require("@google-cloud/logging-winston")
require("dotenv").config()

// Creates a client
const loggingWinston = new LoggingWinston({
  projectId: process.env.PROJECTId,
  keyFilename: process.env.GOOGLE_APPLICATION_CREDENTIALS,
  level: "info", // log at 'warn' and above ,
})

const timezoned = () => {
  return new Date().toLocaleString("zh-TW", {
    timeZone: "Asia/Taipei",
  })
}

// In order for Google Cloud Logging API to understand the log level correctly
const GoogleCloudLoggingFormatter = winston.format((info, opts = {}) => {
  info["severity"] = info["level"].toUpperCase()
  return info
})

// Create a Winston logger that streams to Stackdriver Logging
// Logs will be written to: "projects/YOUR_PROJECT_ID/logs/winston_log"
const logConfiguration = {
  level: "info",
  format: winston.format.combine(
    winston.format.label({
      label: "🔥",
    }),
    winston.format.timestamp({
      format: timezoned,
    }),
    GoogleCloudLoggingFormatter(), // This must be before winston.format.printf()
    winston.format.printf(
      (info) =>
        `${info.level}:${info.label} ${[info.timestamp]} ${info.message}`
    )
  ),
  transports: [
    new transports.File({
      filename: "logs/winston.log",
      format: format.combine(format.align()),
    }),
    new transports.Console({
      format: format.combine(
        format.align(),
        format.colorize({
          all: true,
        }),
        format.label({
          label: "🔥",
        })
      ),
    }),
    // Add Stackdriver Logging
    loggingWinston,
  ],
}
module.exports = logger

```
```javascript
// logs/ winston.log

info:🔥 2021/6/8 下午4:20:32 PUT - /setting/smsPlanFromMsoa
info:🔥 2021/6/8 下午4:20:32 msoaCentralId: 43
info:🔥 2021/6/8 下午4:20:33 response from msoa - message: Success, statue code: 200
info:🔥 2021/6/8 下午4:20:33 SmsPlansFromMsoa is update into database
info:🔥 2021/6/8 下午4:20:33  update msoa data into database - msoaDmpv successfully
```


### Reference :full_moon_with_face:
- [for express-validator](https://express-validator.github.io/docs/)
- [for logger](https://github.com/winstonjs/winston)
